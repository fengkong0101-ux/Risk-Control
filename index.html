<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý Rủi ro — Risk Manager</title>
  <!-- Google Font for modern look -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    :root {
      --maxw: 1100px;
      --accent: #e03131;      /* Primary accent (red) */
      --accent-red: #a30000;  /* Darker red for danger/admin */
    }
    body {
      font-family: 'Inter', Arial, Helvetica, sans-serif;
      background: #f6f8fb;
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .wrap {
      max-width: var(--maxw);
      width: 100%;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(18, 38, 63, 0.06);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 26px;
      background: linear-gradient(90deg, var(--accent), #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    p.lead {
      margin: 0 0 14px;
      color: #445;
      opacity: 0.85;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    select, input, textarea, button {
      font-size: 14px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d4d9de;
    }
    select, input {
      height: 36px;
    }
    textarea {
      resize: vertical;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(224, 49, 49, 0.12);
    }
    .content {
      background: #fcfeff;
      padding: 12px;
      border: 1px solid #eef3fb;
      border-radius: 8px;
      min-height: 120px;
      white-space: pre-line;
    }
    .panel {
      padding: 12px;
      border-radius: 12px;
      background: #fbfdff;
      border: 1px solid #eef3fb;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.18s, transform 0.06s;
    }
    button:active { transform: translateY(1px); }
    button:hover:not(.ghost) {
      background: #a30000;
    }
    button.ghost {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    button.ghost:hover {
      background: var(--accent);
      color: #fff;
    }
    .small {
      padding: 6px 8px;
      font-size: 13px;
    }
    .search {
      flex: 1;
      min-width: 220px;
    }
    .file-input {
      display: inline-block;
    }
    .danger {
      background: var(--accent-red);
    }
    button.danger:hover {
      filter: brightness(0.92);
    }
    .muted {
      color: #667;
      font-size: 13px;
    }
    .hint {
      color: #7a8793;
      font-size: 13px;
    }
    .flex {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .footer {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .admin-indicator {
      margin-left: 10px;
      color: var(--accent-red);
      font-weight: 700;
    }
    /* Modern login form tweaks */
    .login-form {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .login-form input {
      width: 200px;
    }
    @media (max-width: 760px) {
      .meta { max-width: 60%; }
      .row { flex-direction: column; }
      .flex { width: 100%; justify-content: space-between; }
    }
    /* List display */
    .list {
      margin-top: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
    .item {
      padding: 16px;
      border-radius: 10px;
      background: #fcfeff;
      border: none;
      box-shadow: 0 1px 3px rgba(18,38,63,0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.18s, transform 0.06s;
    }
    .item:hover {
      box-shadow: 0 8px 20px rgba(18,38,63,0.08);
      transform: translateY(-2px);
    }
    .item .actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }
    .meta h4 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #223;
    }
    .meta p {
      margin: 0;
      color: #333;
      white-space: pre-line;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.45;
    }
    /* Copy button styles */
    .btn-copy {
      background: transparent;
      border: 1px dashed var(--accent);
      color: var(--accent);
    }
    .btn-copy:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .btn-delete {
      background: var(--accent-red);
      color: #fff;
    }
    .btn-delete:hover {
      filter: brightness(0.92);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
      <div>
        <h1>Quản lý Rủi ro (Risk Manager) <span>@Ren</span></h1>
        <p class="lead">Chọn Hệ → Nhóm lỗi (chỉ hiển thị các lỗi trong Hệ đó). Thêm / Sửa / Xóa / Xuất / Nhập dữ liệu</p>
      </div>
      <div style="text-align: right;">
        <div style="margin-bottom: 8px;">
          <button id="loginBtn" class="small ghost">Đăng nhập Admin</button>
          <div id="loginForm" class="login-form" style="display: none;">
            <input id="adminPwdInput" type="password" placeholder="Mật khẩu Admin">
            <button id="loginConfirmBtn" class="small ghost">OK</button>
          </div>
          <button id="logoutBtn" class="small ghost" style="display: none;">Thoát Admin</button>
          <span id="adminStatus" class="admin-indicator" style="display: none;">ADMIN</span>
        </div>
        <div class="hint">Admin: có quyền sửa</div>
      </div>
    </div>

    <div class="row" style="margin-top: 8px;">
      <div style="flex: 1; min-width: 220px;">
        <label class="muted">Chọn Hệ</label>
        <select id="systemSelect"></select>
      </div>
      <div style="flex: 1; min-width: 220px;">
        <label class="muted">Chọn Nhóm lỗi</label>
        <select id="groupSelect"></select>
      </div>
      <div style="min-width: 160px;">
        <label class="muted">Tìm (tiêu đề / nội dung)</label>
        <input id="searchBox" class="search" placeholder="Gõ từ khóa...">
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="muted">Kết quả</div>
            <div>
              <button id="copyOutputBtn" class="small ghost">Sao chép</button>
            </div>
          </div>
          <div id="output" class="content">Chọn Hệ và Nhóm lỗi để xem nội dung</div>
        </div>
        <div style="width: 320px;">
          <div class="muted">Thêm / Sửa mục</div>
          <input id="newSystem" placeholder="Hệ (vd: RUMMY)" />
          <input id="newGroup" placeholder="Nhóm lỗi (vd: TRÙNG IP)" />
          <input id="newTitle" placeholder="Tiêu đề (vd: RUMMY TRÙNG IP)" />
          <textarea id="newContent" rows="6" placeholder="Nội dung chi tiết..."></textarea>
          <div class="controls" style="margin-top: 8px;">
            <button id="addButton" class="small admin-only">ADD</button>
            <button id="updateButton" class="small ghost admin-only" style="display: none;">UPDATE</button>
            <button id="clearForm" class="small">CLEAR</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="flex">
        <button id="exportBtn" class="small">Export JSON</button>
        <label class="file-input small ghost admin-only" style="padding: 6px 10px; cursor: pointer;">
          Import JSON <input id="importFile" type="file" accept="application/json" style="display: none;">
        </label>
        <button id="resetBtn" class="small ghost admin-only">Reset to default</button>
      </div>
      <div class="hint">Lưu ý: dữ liệu sẽ được tải từ file data.json. Dùng Export để chia sẻ (file .json).</div>
    </div>

    <hr style="margin: 12px 0; border: none; border-top: 1px dashed #eef3fb;">
    <div class="list" id="listArea"></div>
  </div>

<script>
/* ------------------ DOM refs ------------------ */
const systemSelect = document.getElementById('systemSelect');
const groupSelect = document.getElementById('groupSelect');
const output = document.getElementById('output');
const listArea = document.getElementById('listArea');
const searchBox = document.getElementById('searchBox');

const newSystem = document.getElementById('newSystem');
const newGroup = document.getElementById('newGroup');
const newTitle = document.getElementById('newTitle');
const newContent = document.getElementById('newContent');
const addButton = document.getElementById('addButton');
const updateButton = document.getElementById('updateButton');
const clearForm = document.getElementById('clearForm');

const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const resetBtn = document.getElementById('resetBtn');

const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const adminStatus = document.getElementById('adminStatus');
const loginForm = document.getElementById('loginForm');
const adminPwdInput = document.getElementById('adminPwdInput');
const loginConfirmBtn = document.getElementById('loginConfirmBtn');

/* ------------------ CẤU HÌNH ADMIN ------------------ */
const ADMIN_PASSWORD = 'admin'; // <-- đổi giá trị nếu cần
const ADMIN_LS_KEY = 'isAdmin_v1';

/* ------------------ GitHub configuration ------------------ */
// GitHub token lấy từ RISK_MANAGER_TOKEN (localStorage) để ẩn token
const GITHUB_TOKEN = localStorage.getItem('RISK_MANAGER_TOKEN');
const GITHUB_OWNER  = 'fengkong0101-ux';
const GITHUB_REPO   = 'Risk-Control';
const GITHUB_BRANCH = 'main';

/* ------------------ HÀM MÃ HÓA BASE64 ------------------ */
function base64Encode(str) {
  return window.btoa(unescape(encodeURIComponent(str)));
}

/* ------------------ Lưu dữ liệu lên GitHub ------------------ */
async function saveDataToGitHub() {
  if (!isAdmin()) return;
  const token = localStorage.getItem('RISK_MANAGER_TOKEN') || '';
  if (!token) {
    alert('GitHub token chưa được thiết lập.');
    return;
  }

  const content = JSON.stringify(data, null, 2);
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/data.json?ref=${GITHUB_BRANCH}`;

  async function fetchFileSha() {
    const res = await fetch(url, { cache: 'no-store', headers: { 'Authorization': 'token ' + token }});
    if (res.status === 404) return { exists: false, sha: null };
    const j = await res.json();
    return { exists: true, sha: j.sha };
  }

  const maxAttempts = 3;
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const fileInfo = await fetchFileSha();

      const body = {
        message: fileInfo.exists ? 'Update data via admin UI' : 'Create data via admin UI',
        branch: GITHUB_BRANCH,
        content: btoa(unescape(encodeURIComponent(content)))
      };
      if (fileInfo.exists && fileInfo.sha) body.sha = fileInfo.sha;

      const putRes = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/data.json`, {
        method: 'PUT',
        headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const putJson = await putRes.json();

      if (putRes.ok && putJson.content) {
        alert('Dữ liệu đã được lưu trên GitHub!');
        return;
      } else if (putRes.status === 409) {
        if (attempt < maxAttempts) { await new Promise(r => setTimeout(r, 400 * attempt)); continue; }
        alert('Lưu thất bại do xung đột. Vui lòng tải lại trang để lấy phiên bản mới.');
        return;
      } else {
        alert('Lưu thất bại: ' + JSON.stringify(putJson));
        return;
      }
    } catch (err) {
      console.error('Lỗi khi lưu lên GitHub:', err);
      alert('Lỗi khi lưu lên GitHub: ' + (err.message || err));
      return;
    }
  }
}

/* ------------------ DỮ LIỆU MẶC ĐỊNH ------------------ */
const DEFAULT_DATA = [
  { system: "RUMMY", group: "TRÙNG IP", title: "RUMMY TRÙNG IP", content: "會員ID : \n*拒絕原因 : 我本人沒有充值，上級有多個IP地址，不符合RUMMY MATCH的提現條件。\n*會員風險評級 : 有問題\n*結論 : 扣除獎勵" },
  { system: "RUMMY", group: "KHÔNG NẠP", title: "RUMMY KHÔNG NẠP", content: "會員ID : \n*拒絕原因 : 我和上級都領取了獎勵，但還未充值，未達到提現獎勵的條件。\n*會員風險評級 : 中嫌疑\n*結論 : 要求會員充值。" },
  { system: "RUMMY", group: "TỈ LỆ THẤP", title: "RUMMY TỈ LỆ THẤP", content: "會員ID : \n*拒絕原因 : 以低投注比例領取 RUMMY 獎勵\n*會員風險評級 : 有問題\n*結論 : 扣除獎勵" },
  { system: "CHƠI MỨC CƯỢC QUÁ THẤP", group: "TỈ LỆ THẤP", title: "CHƠI MỨC CƯỢC QUÁ THẤP - TỈ LỆ THẤP", content: "會員ID : \n*拒絕原因 : 故意下注小額，達到流水直接提現 刷首充獎勵\n*會員風險評級 : 中嫌疑\n*結論 : 讓會員繼續下注" }
];

/* ------------------ DỮ LIỆU HIỆN TẠI ------------------ */
let data = [];
let editIndex = -1;

/* ------------------ CHỨC NĂNG QUYỀN ------------------ */
function isAdmin() { return localStorage.getItem(ADMIN_LS_KEY) === '1'; }
function applyPermission() {
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin() ? '' : 'none';
  });
  if (isAdmin()) {
    loginBtn.style.display = 'none';
    loginForm.style.display = 'none';
    logoutBtn.style.display = '';
    adminStatus.style.display = '';
  } else {
    loginBtn.style.display = '';
    loginForm.style.display = 'none';
    logoutBtn.style.display = 'none';
    adminStatus.style.display = 'none';
  }
}

/* ------------------ CHỨC NĂNG HIỂN THỊ ------------------ */
function getUniqueSystems() {
  return [...new Set(data.map(d => d.system))].sort();
}
function getGroupsFor(system) {
  return [...new Set(data.filter(d => d.system === system).map(d => d.group))].sort();
}

function populateSystems() {
  const selected = systemSelect.value;
  systemSelect.innerHTML = '';
  getUniqueSystems().forEach(s => {
    const o = document.createElement('option');
    o.value = s; o.textContent = s;
    systemSelect.appendChild(o);
  });
  if (selected && [...systemSelect.options].some(o => o.value === selected)) {
    systemSelect.value = selected;
  }
  populateGroups();
}

function populateGroups() {
  const sys = systemSelect.value;
  groupSelect.innerHTML = '';
  const allOpt = document.createElement('option');
  allOpt.value = '';
  allOpt.textContent = 'Tất cả nhóm';
  groupSelect.appendChild(allOpt);
  if (sys) {
    const groups = getGroupsFor(sys);
    groups.forEach(g => {
      const o = document.createElement('option');
      o.value = g; o.textContent = g;
      groupSelect.appendChild(o);
    });
  }
  populateContent();
  renderList();
}

function populateContent() {
  const sys = systemSelect.value;
  const grp = groupSelect.value;
  if (!sys) {
    output.textContent = 'Chọn Hệ để xem nội dung';
    return;
  }
  let items = [];
  if (!grp) items = data.filter(d => d.system === sys);
  else items = data.filter(d => d.system === sys && d.group === grp);
  if (items.length) {
    output.textContent = items.map(i => `Tiêu đề: ${i.title}\n${i.content}`).join('\n\n');
  } else {
    output.textContent = 'Không có dữ liệu';
  }
}

function renderList() {
  listArea.innerHTML = '';
  const q = (searchBox.value || '').trim().toLowerCase();
  data.forEach((d, idx) => {
    if (q) {
      const hay = (d.title + ' ' + d.content + ' ' + d.system + ' ' + d.group).toLowerCase();
      if (!hay.includes(q)) return;
    }
    const item = document.createElement('div'); item.className = 'item';
    const meta = document.createElement('div'); meta.className = 'meta';
    const h4 = document.createElement('h4');
    h4.textContent = `${d.title} — ${d.system} / ${d.group}`;
    const p = document.createElement('p'); p.textContent = d.content;
    meta.appendChild(h4); meta.appendChild(p);

    const actions = document.createElement('div'); actions.className = 'actions';
    const btnCopy = document.createElement('button');
    btnCopy.className = 'small btn-copy';
    btnCopy.textContent = 'Sao chép';
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(d.content)
        .then(() => alert('Nội dung đã được sao chép!'))
        .catch(() => alert('Sao chép thất bại'));
    };
    actions.appendChild(btnCopy);

    if (isAdmin()) {
      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Sửa';
      btnEdit.className = 'small ghost';
      btnEdit.onclick = () => { startEdit(idx); };
      actions.appendChild(btnEdit);

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Xóa';
      btnDel.className = 'small btn-delete';
      btnDel.onclick = () => {
        if (!isAdmin()) { alert('Bạn không có quyền xóa'); return; }
        if (confirm('Xác nhận xóa mục này?')) {
          data.splice(idx, 1);
          populateSystems();
          saveDataToGitHub(); // Lưu dữ liệu sau khi xóa
        }
      };
      actions.appendChild(btnDel);
    }

    item.appendChild(meta);
    item.appendChild(actions);
    listArea.appendChild(item);
  });
}

/* ------------------ THÊM / SỬA ------------------ */
addButton.addEventListener('click', () => {
  const sys = newSystem.value.trim();
  const grp = newGroup.value.trim();
  const title = newTitle.value.trim();
  const cont = newContent.value.trim();
  if (!sys || !grp || !title || !cont) {
    alert('Vui lòng nhập đầy đủ Hệ, Nhóm lỗi, Tiêu đề và Nội dung');
    return;
  }
  data.push({ system: sys, group: grp, title: title, content: cont });
  clearInputs();
  populateSystems();
  // Sau khi thêm, chọn hệ và nhóm mới
  systemSelect.value = sys;
  populateGroups();
  groupSelect.value = grp;
  populateContent();
  renderList();
  saveDataToGitHub(); // Lưu dữ liệu sau khi thêm
});

function startEdit(idx) {
  if (!isAdmin()) { alert('Bạn cần đăng nhập Admin để sửa'); return; }
  editIndex = idx;
  const d = data[idx];
  newSystem.value = d.system;
  newGroup.value = d.group;
  newTitle.value = d.title;
  newContent.value = d.content;
  updateButton.style.display = 'inline-block';
  addButton.style.display = 'none';
}

updateButton.addEventListener('click', () => {
  if (editIndex < 0) { alert('Không có mục nào đang sửa'); return; }
  const sys = newSystem.value.trim();
  const grp = newGroup.value.trim();
  const title = newTitle.value.trim();
  const cont = newContent.value.trim();
  if (!sys || !grp || !title || !cont) {
    alert('Vui lòng nhập đầy đủ Hệ, Nhóm lỗi, Tiêu đề và Nội dung');
    return;
  }
  data[editIndex] = { system: sys, group: grp, title: title, content: cont };
  editIndex = -1;
  clearInputs();
  addButton.style.display = 'inline-block';
  updateButton.style.display = 'none';
  populateSystems();
  saveDataToGitHub(); // Lưu dữ liệu sau khi cập nhật
});

clearForm.addEventListener('click', () => { clearInputs(); });
function clearInputs() {
  newSystem.value = '';
  newGroup.value = '';
  newTitle.value = '';
  newContent.value = '';
}

/* ------------------ Export / Import ------------------ */
exportBtn.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'riskData.json'; a.click();
  URL.revokeObjectURL(url);
});

importFile.addEventListener('change', (e) => {
  if (!isAdmin()) { alert('Bạn cần đăng nhập Admin để import'); importFile.value = ''; return; }
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const arr = JSON.parse(reader.result);
      if (!Array.isArray(arr)) throw new Error('File không đúng định dạng (cần mảng JSON)');
      if (confirm('Nhập file sẽ **thay thế** dữ liệu hiện tại. Bạn có muốn tiếp tục?')) {
        data = arr; populateSystems(); alert('Nhập file thành công');
      }
    } catch(err) {
      alert('Lỗi khi đọc file: ' + err.message);
    }
  };
  reader.readAsText(f);
});

resetBtn.addEventListener('click', () => {
  if (!isAdmin()) { alert('Bạn cần đăng nhập Admin để reset'); return; }
  if (confirm('Reset về dữ liệu mặc định?')) {
    data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    applyPermission();
    populateSystems();
  }
});

/* ------------------ SEARCH / FILTER ------------------ */
searchBox.addEventListener('input', () => { renderList(); });
systemSelect.addEventListener('change', () => { populateGroups(); });
groupSelect.addEventListener('change', () => { populateContent(); renderList(); });

/* ------------------ COPY KẾT QUẢ ------------------ */
const copyOutputBtn = document.getElementById('copyOutputBtn');
copyOutputBtn.addEventListener('click', () => {
  const text = output.textContent;
  navigator.clipboard.writeText(text)
    .then(() => alert('Nội dung kết quả đã được sao chép!'))
    .catch(() => alert('Sao chép thất bại'));
});

/* ------------------ ADMIN LOGIN ------------------ */
loginBtn.addEventListener('click', () => {
  loginForm.style.display = 'flex';
  loginBtn.style.display = 'none';
  adminPwdInput.focus();
});

loginConfirmBtn.addEventListener('click', () => {
  const pwd = adminPwdInput.value;
  if (pwd === ADMIN_PASSWORD) {
    localStorage.setItem(ADMIN_LS_KEY, '1');
    applyPermission();
    alert('Đăng nhập Admin thành công');
    renderList();
  } else {
    alert('Sai mật khẩu');
  }
});

logoutBtn.addEventListener('click', () => {
  localStorage.removeItem(ADMIN_LS_KEY);
  applyPermission();
  alert('Đã thoát Admin');
  renderList();
});

/* ------------------ INITIAL LOAD ------------------ */
// Tải dữ liệu từ file data.json
fetch('data.json')
  .then(response => response.json())
  .then(arr => {
    data = arr;
    applyPermission();
    populateSystems();
  })
  .catch(error => {
    console.error('Error loading data.json:', error);
    // Nếu không tải được, dùng dữ liệu mặc định
    data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    applyPermission();
    populateSystems();
  });
</script>
</body>
</html>


